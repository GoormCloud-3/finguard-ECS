name: ECS Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "ÌôòÍ≤Ω ÏÑ†ÌÉù (dev, main)"
        required: true
        default: "dev"
      confirm:
        description: "ÏßÑÏßúÎ°ú ÏÇ≠Ï†úÌïòÎ†§Î©¥ EXACTLY ÏûÖÎ†•: DELETE"
        required: true
        default: "type DELETE"

env:
  AWS_REGION: ap-northeast-2
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  CLUSTER_NAME: ecs-cluster
  SERVICES: account-service,transaction-service,user-service,sqs-service,fcm-service
  REPOS: account-service,transaction-service,user-service,sqs-service,fcm-service,xray-daemon
  FAMILIES: account,sqs,transaction,user,fcm

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Safety check (require DELETE)
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.confirm }}" != "DELETE" ]; then
            echo "‚ùå You must type DELETE to proceed." >&2
            exit 1
          fi

      - name: Mask account id
        run: echo "::add-mask::${AWS_ACCOUNT_ID}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/ecs-deploy-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubECSDestroySession

      - name: Ensure tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Stop & Delete ECS Services (scale to 0 and wait)
        run: |
          set -euo pipefail
          IFS=',' read -ra svcs <<< "$SERVICES"

          for svc in "${svcs[@]}"; do
            STATUS=$(aws ecs describe-services \
              --cluster "$CLUSTER_NAME" --services "$svc" \
              --region "$AWS_REGION" \
              --query "services[0].status" --output text 2>/dev/null || echo "MISSING")

            if [ "$STATUS" = "ACTIVE" ] || [ "$STATUS" = "DRAINING" ]; then
              echo "‚û°Ô∏è  Scaling $svc to 0"
              aws ecs update-service \
                --cluster "$CLUSTER_NAME" --service "$svc" \
                --desired-count 0 --region "$AWS_REGION" >/dev/null

              echo "‚è≥ Waiting for tasks to stop: $svc"
              for i in $(seq 1 30); do
                RUNNING=$(aws ecs describe-services \
                  --cluster "$CLUSTER_NAME" --services "$svc" \
                  --region "$AWS_REGION" \
                  --query 'services[0].runningCount' --output text 2>/dev/null || echo 0)
                if [ "$RUNNING" = "0" ] || [ "$RUNNING" = "None" ] || [ -z "$RUNNING" ]; then
                  break
                fi
                sleep 10
              done

              echo "üóëÔ∏è  Deleting service $svc"
              aws ecs delete-service \
                --cluster "$CLUSTER_NAME" --service "$svc" \
                --force --region "$AWS_REGION" >/dev/null || true

              # ÏÇ¨ÎùºÏßà ÎïåÍπåÏßÄ ÎåÄÍ∏∞
              for i in $(seq 1 18); do
                OUT=$(aws ecs describe-services \
                  --cluster "$CLUSTER_NAME" --services "$svc" \
                  --region "$AWS_REGION" \
                  --query "services[0].status" --output text 2>/dev/null || echo "MISSING")
                if [ "$OUT" = "None" ] || [ "$OUT" = "MISSING" ]; then
                  break
                fi
                sleep 10
              done
            else
              echo "‚ÑπÔ∏è  Service $svc not ACTIVE; skipping"
            fi
          done

      - name: Deregister Task Definitions (all ACTIVE revisions)
        run: |
          set -euo pipefail
          IFS=',' read -ra families <<< "$FAMILIES"

          for fam in "${families[@]}"; do
            echo "‚û°Ô∏è  Deregistering ACTIVE task defs for family: ${fam}-task"
            ARNS=$(aws ecs list-task-definitions \
              --family-prefix "${fam}-task" --status ACTIVE \
              --region "$AWS_REGION" \
              --query "taskDefinitionArns[]" --output text || true)
            if [ -n "$ARNS" ] && [ "$ARNS" != "None" ]; then
              for arn in $ARNS; do
                aws ecs deregister-task-definition \
                  --task-definition "$arn" --region "$AWS_REGION" || true
              done
            else
              echo "‚ÑπÔ∏è  No ACTIVE task defs for ${fam}-task"
            fi
          done

      - name: Delete all images in ECR repositories (paged)
        run: |
          set -euo pipefail
          IFS=',' read -ra repos <<< "$REPOS"

          for repo in "${repos[@]}"; do
            echo "‚û°Ô∏è  Deleting images in repo: $repo"
            NEXT=""
            while :; do
              if [ -z "$NEXT" ] || [ "$NEXT" = "None" ]; then
                PAGE=$(aws ecr list-images --repository-name "$repo" \
                        --region "$AWS_REGION" 2>/dev/null || echo '{}')
              else
                PAGE=$(aws ecr list-images --repository-name "$repo" \
                        --region "$AWS_REGION" --next-token "$NEXT" 2>/dev/null || echo '{}')
              fi

              IDS=$(echo "$PAGE" | jq -c '.imageIds // []')
              NEXT=$(echo "$PAGE" | jq -r '.nextToken // "None"')

              if [ "$(echo "$IDS" | jq 'length')" -eq 0 ]; then
                [ "$NEXT" = "None" ] && break || continue
              fi

              aws ecr batch-delete-image \
                --repository-name "$repo" \
                --image-ids "$IDS" \
                --region "$AWS_REGION" >/dev/null || true

              [ "$NEXT" = "None" ] && break
            done
          done

      - name: Delete ECR Repositories (force)
        run: |
          set -euo pipefail
          IFS=',' read -ra repos <<< "$REPOS"

          for repo in "${repos[@]}"; do
            echo "üóëÔ∏è  Deleting ECR repo: $repo"
            aws ecr delete-repository --repository-name "$repo" \
              --force --region "$AWS_REGION" >/dev/null || true
          done

      - name: Delete ECS Cluster
        run: |
          set -euo pipefail
          STATUS=$(aws ecs describe-clusters \
            --clusters "$CLUSTER_NAME" --region "$AWS_REGION" \
            --query "clusters[0].status" --output text 2>/dev/null || echo "MISSING")
          if [ "$STATUS" = "ACTIVE" ]; then
            echo "üóëÔ∏è  Deleting cluster: $CLUSTER_NAME"
            aws ecs delete-cluster --cluster "$CLUSTER_NAME" \
              --region "$AWS_REGION" >/dev/null
          else
            echo "‚ÑπÔ∏è  Cluster not ACTIVE or missing; skipping"
          fi
